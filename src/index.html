<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Annuaire Sant√© ‚Äî Recherche de professionnels</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
            accent: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a' },
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .spinner { border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 1.7s forwards; }
    @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } }
    @keyframes fadeOut { to { opacity: 0; transform: translateY(-10px); } }
    .card-hover { transition: box-shadow 0.2s, transform 0.15s; }
    .card-hover:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); transform: translateY(-1px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary-600 rounded-xl flex items-center justify-center">
          <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </div>
        <div>
          <h1 class="text-lg font-bold text-gray-900">Annuaire Sant√©</h1>
          <p class="text-xs text-gray-500">Recherche de professionnels de sant√©</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="toggleBasketPanel()" id="btn-basket" class="hidden items-center gap-2 px-3 py-2 text-primary-700 bg-primary-50 hover:bg-primary-100 text-sm font-medium rounded-lg transition-colors relative">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 100 4 2 2 0 000-4z"/></svg>
          <span id="basket-count">0</span> s√©lectionn√©(s)
        </button>
        <button onclick="toggleSelectAll()" id="btn-select-all" class="hidden items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-800 text-sm font-medium border border-gray-300 rounded-lg transition-colors">
          Tout s√©lectionner
        </button>
        <button onclick="exportCSV()" id="btn-export" class="hidden items-center gap-2 px-4 py-2 bg-accent-500 hover:bg-accent-600 text-white text-sm font-medium rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Export CSV
        </button>
      </div>
    </div>
  </header>

  <!-- Search Section -->
  <main class="max-w-6xl mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-8">
      <form id="search-form" onsubmit="doSearch(event)" class="space-y-4">
        <!-- Row 1 : Name + RPPS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Nom du professionnel</label>
            <input type="text" id="input-name" placeholder="Ex : Dupont, Martin Jean..."
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">N¬∞ RPPS</label>
            <input type="text" id="input-rpps" placeholder="Ex : 10101234567"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all text-sm">
          </div>
        </div>
        <!-- Row 2 : City + Specialty -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Ville</label>
            <input type="text" id="input-city" placeholder="Ex : Paris, Lyon, Marseille..." autocomplete="off"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all text-sm"
              oninput="onCityInput(this.value)" onblur="setTimeout(()=>hideCitySuggestions(),200)">
            <ul id="city-suggestions" class="hidden absolute z-40 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></ul>
          </div>
          <div class="relative">
            <label class="block text-sm font-medium text-gray-700 mb-1">Sp√©cialit√©</label>
            <input type="text" id="input-specialty" placeholder="Ex : Cardiologue, Chirurgien..." autocomplete="off"
              class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all text-sm"
              oninput="onSpecialtyInput(this.value)" onfocus="onSpecialtyInput(this.value)" onblur="setTimeout(()=>hideSpecialtySuggestions(),200)">
            <ul id="specialty-suggestions" class="hidden absolute z-40 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"></ul>
          </div>
        </div>
        <!-- Submit -->
        <div class="flex items-center gap-4">
          <button type="submit" id="btn-search"
            class="px-6 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            Rechercher
          </button>
          <button type="button" onclick="clearForm()" class="px-4 py-2.5 text-gray-600 hover:text-gray-800 text-sm font-medium transition-colors">
            Effacer
          </button>
          <div id="loading" class="hidden"><div class="spinner"></div></div>
          <span id="result-count" class="text-sm text-gray-500 ml-auto"></span>
        </div>
      </form>
    </div>

    <!-- Results -->
    <div id="results" class="space-y-4"></div>

    <!-- Empty state -->
    <div id="empty-state" class="text-center py-16">
      <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <p class="text-gray-500 text-sm">Recherchez un professionnel de sant√© par nom, RPPS, ville ou sp√©cialit√©</p>
    </div>

    <!-- Error state -->
    <div id="error-state" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
        <p class="text-red-700 font-medium mb-1">Erreur lors de la recherche</p>
        <p id="error-msg" class="text-red-600 text-sm"></p>
      </div>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toasts" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <!-- Basket Panel -->
  <div id="basket-panel" class="hidden fixed inset-0 z-40">
    <div class="absolute inset-0 bg-black/30" onclick="toggleBasketPanel()"></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl flex flex-col">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="font-bold text-gray-900">Ma s√©lection</h2>
        <div class="flex items-center gap-3">
          <button onclick="clearBasket()" class="text-sm text-red-500 hover:text-red-700 font-medium">Tout vider</button>
          <button onclick="toggleBasketPanel()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div id="basket-list" class="flex-1 overflow-y-auto px-6 py-4 space-y-3"></div>
      <div class="px-6 py-4 border-t border-gray-200 space-y-2">
        <button onclick="exportBasketCSV()" class="w-full px-4 py-2.5 bg-accent-500 hover:bg-accent-600 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2 text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          Exporter la s√©lection en CSV
        </button>
        <button onclick="copyAllBasket()" class="w-full px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-lg transition-colors flex items-center justify-center gap-2 text-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
          Copier toutes les fiches
        </button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="modal-overlay" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
    <div class="bg-white rounded-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
      <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between rounded-t-2xl">
        <h2 class="font-bold text-gray-900">Fiche praticien</h2>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="modal-body" class="px-6 py-4"></div>
      <div class="sticky bottom-0 bg-white border-t border-gray-100 px-6 py-3 flex gap-3 rounded-b-2xl">
        <button onclick="copyCurrentCard()" class="flex-1 px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors flex items-center justify-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
          Copier la fiche
        </button>
        <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 text-sm font-medium border border-gray-300 rounded-lg transition-colors">
          Fermer
        </button>
      </div>
    </div>
  </div>

<script>
// ‚îÄ‚îÄ‚îÄ Sp√©cialit√©s m√©dicales fran√ßaises avec codes NOS (TRE-R38-SpecialiteOrdinale) ‚îÄ‚îÄ‚îÄ
const SPECIALTIES = [
  { label: "Allergologie", code: "SM57" },
  { label: "Anatomie et Cytologie pathologiques", code: "SM01" },
  { label: "Anesth√©sie-r√©animation", code: "SM02" },
  { label: "Biologie m√©dicale", code: "SM03" },
  { label: "Cardiologie et Maladies vasculaires", code: "SM04" },
  { label: "Chirurgie g√©n√©rale", code: "SM05" },
  { label: "Chirurgie infantile", code: "SM09" },
  { label: "Chirurgie maxillo-faciale et Stomatologie", code: "SM07" },
  { label: "Chirurgie orale", code: "SM56" },
  { label: "Chirurgie orthop√©dique et Traumatologie", code: "SM08" },
  { label: "Chirurgie plastique reconstructrice et esth√©tique", code: "SM10" },
  { label: "Chirurgie thoracique et cardio-vasculaire", code: "SM11" },
  { label: "Chirurgie urologique", code: "SM12" },
  { label: "Chirurgie vasculaire", code: "SM13" },
  { label: "Chirurgie visc√©rale et digestive", code: "SM14" },
  { label: "Dermatologie et V√©n√©r√©ologie", code: "SM15" },
  { label: "Endocrinologie, diab√©tologie, nutrition", code: "SM62" },
  { label: "Gastro-ent√©rologie et H√©patologie", code: "SM24" },
  { label: "G√©n√©tique m√©dicale", code: "SM17" },
  { label: "G√©riatrie", code: "SM18" },
  { label: "Gyn√©cologie m√©dicale", code: "SM19" },
  { label: "Gyn√©cologie-obst√©trique", code: "SM20" },
  { label: "H√©matologie", code: "SM21" },
  { label: "Maladies infectieuses et tropicales", code: "SM58" },
  { label: "M√©decine cardiovasculaire", code: "SM73" },
  { label: "M√©decine d'urgence", code: "SM59" },
  { label: "M√©decine du travail", code: "SM25" },
  { label: "M√©decine g√©n√©rale", code: "SM54" },
  { label: "M√©decine intensive-r√©animation", code: "SM46" },
  { label: "M√©decine interne", code: "SM27" },
  { label: "M√©decine interne et immunologie clinique", code: "SM72" },
  { label: "M√©decine l√©gale et expertises m√©dicales", code: "SM60" },
  { label: "M√©decine nucl√©aire", code: "SM28" },
  { label: "M√©decine physique et de r√©adaptation", code: "SM29" },
  { label: "M√©decine vasculaire", code: "SM61" },
  { label: "N√©phrologie", code: "SM30" },
  { label: "Neuro-chirurgie", code: "SM31" },
  { label: "Neurologie", code: "SM32" },
  { label: "ORL et Chirurgie cervico-faciale", code: "SM34" },
  { label: "Oncologie, option m√©dicale", code: "SM36" },
  { label: "Oncologie, option radioth√©rapie", code: "SM37" },
  { label: "Ophtalmologie", code: "SM38" },
  { label: "Orthop√©die dento-faciale", code: "SCD01" },
  { label: "Oto-rhino-laryngologie", code: "SM39" },
  { label: "P√©diatrie", code: "SM40" },
  { label: "Pneumologie", code: "SM41" },
  { label: "Psychiatrie", code: "SM42" },
  { label: "Psychiatrie, option enfant et adolescent", code: "SM43" },
  { label: "Radiologie et imagerie m√©dicale", code: "SM74" },
  { label: "Radio-diagnostic", code: "SM44" },
  { label: "Radio-th√©rapie", code: "SM45" },
  { label: "Rhumatologie", code: "SM48" },
  { label: "Sant√© publique", code: "SM75" },
  { label: "Stomatologie", code: "SM50" },
  { label: "M√©decine bucco-dentaire", code: "SCD03" },
];

// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ
const API_URL = '/api'; // Cloudflare Worker proxy (same domain)

let currentResults = [];
let currentDetail = null;
let selectedIndices = new Set();
let basket = []; // Panier persistant entre les recherches

// ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ
async function doSearch(e) {
  e.preventDefault();
  const name = document.getElementById('input-name').value.trim();
  const rpps = document.getElementById('input-rpps').value.trim();
  const city = document.getElementById('input-city').value.trim();
  const specialtyText = document.getElementById('input-specialty').value.trim();

  if (!name && !rpps && !city && !specialtyText) {
    showToast('Remplis au moins un crit√®re de recherche', 'warn');
    return;
  }

  setLoading(true);
  hideError();

  // Find the specialty code from the label
  const specObj = SPECIALTIES.find(s => s.label.toLowerCase() === specialtyText.toLowerCase());
  const specialtyCode = specObj ? specObj.code : '';

  const params = new URLSearchParams();
  if (name) params.set('name', name);
  if (rpps) params.set('rpps', rpps);
  if (city) params.set('city', city);
  if (specialtyCode) params.set('specialty_code', specialtyCode);
  if (specialtyText && !specialtyCode) params.set('specialty', specialtyText);

  try {
    const fetchUrl = `${API_URL}/search?${params.toString()}`;
    console.log('[Annuaire] Fetching:', fetchUrl);
    const res = await fetch(fetchUrl);
    console.log('[Annuaire] Response status:', res.status);
    const data = await res.json();
    console.log('[Annuaire] Data:', data);
    if (!res.ok) throw new Error(data.error || `Erreur ${res.status}`);

    currentResults = data.results || [];
    renderResults(currentResults);
    const totalFhir = data.totalFhir || 0;
    let countText = `${currentResults.length} r√©sultat${currentResults.length > 1 ? 's' : ''}`;
    if (totalFhir > currentResults.length) {
      countText += ` sur ${totalFhir.toLocaleString('fr-FR')}`;
    }
    document.getElementById('result-count').textContent = countText;
    if (data.message) showToast(data.message, 'warn');
    updateBasketUI();
    const hasResults = currentResults.length > 0;
    document.getElementById('btn-export').classList.toggle('hidden', !hasResults);
    document.getElementById('btn-export').classList.toggle('flex', hasResults);
    document.getElementById('btn-select-all').classList.toggle('hidden', !hasResults);
    document.getElementById('btn-select-all').classList.toggle('flex', hasResults);
    updateBasketUI();
  } catch (err) {
    showError(err.message);
    currentResults = [];
    document.getElementById('results').innerHTML = '';
    document.getElementById('result-count').textContent = '';
  } finally {
    setLoading(false);
  }
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ
function renderResults(results) {
  const container = document.getElementById('results');
  const empty = document.getElementById('empty-state');

  if (results.length === 0) {
    container.innerHTML = '<div class="text-center py-12 text-gray-500 text-sm">Aucun r√©sultat trouv√©. Essayez avec d\'autres crit√®res.</div>';
    empty.classList.add('hidden');
    return;
  }

  empty.classList.add('hidden');
  container.innerHTML = results.map((p, i) => {
    const mainRole = p.roles?.[0] || {};
    const specs = p.roles?.flatMap(r => r.specialties || []).filter(Boolean) || [];
    const uniqueSpecs = [...new Set(specs)];
    const qualifs = p.qualifications?.map(q => q.display).filter(Boolean) || [];
    const displayQualifs = [...new Set([...uniqueSpecs, ...qualifs])].slice(0, 3);
    const displayAddress = mainRole.address || mainRole.organization?.address || '';
    const displayOrg = mainRole.organization?.name || '';

    const isSelected = isInBasket(p);
    return `
      <div class="bg-white rounded-xl border ${isSelected ? 'border-primary-400 ring-2 ring-primary-100' : 'border-gray-200'} p-5 card-hover fade-in" style="animation-delay: ${i * 50}ms">
        <div class="flex items-start gap-3">
          <div class="pt-0.5 shrink-0">
            <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelect(${i})"
              class="w-5 h-5 rounded border-gray-300 text-primary-600 focus:ring-primary-500 cursor-pointer">
          </div>
          <div class="flex-1 min-w-0 cursor-pointer" onclick="openDetail(${i})">
            <div class="flex items-center gap-2 mb-1">
              <h3 class="font-semibold text-gray-900 truncate">${esc(p.prefix)} ${esc(p.firstName)} ${esc(p.lastName)}</h3>
              ${p.rpps ? `<span class="text-xs bg-primary-50 text-primary-700 px-2 py-0.5 rounded-full font-medium shrink-0">RPPS ${esc(p.rpps)}</span>` : ''}
            </div>
            ${displayQualifs.length ? `<p class="text-sm text-primary-600 mb-1">${displayQualifs.map(esc).join(' ¬∑ ')}</p>` : ''}
            ${displayOrg ? `<p class="text-sm text-gray-600 mb-0.5">üè• ${esc(displayOrg)}</p>` : ''}
            ${displayAddress ? `<p class="text-sm text-gray-500 flex items-center gap-1">
              <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              ${esc(displayAddress)}
            </p>` : ''}
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <button onclick="event.stopPropagation(); copyCard(${i})" title="Copier la fiche"
              class="p-2 text-gray-400 hover:text-primary-600 hover:bg-primary-50 rounded-lg transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
            </button>
            <svg class="w-4 h-4 text-gray-300 cursor-pointer" onclick="openDetail(${i})" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </div>
        </div>
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ Detail Modal ‚îÄ‚îÄ‚îÄ
function openDetail(index) {
  const p = currentResults[index];
  if (!p) return;
  currentDetail = p;

  const body = document.getElementById('modal-body');
  const telecoms = p.roles?.flatMap(r => r.telecoms || []).filter(t => t.value) || [];
  const uniqueTelecoms = [];
  const seenTel = new Set();
  for (const t of telecoms) {
    const key = `${t.system}:${t.value}`;
    if (!seenTel.has(key)) { seenTel.add(key); uniqueTelecoms.push(t); }
  }

  const specs = [...new Set(p.roles?.flatMap(r => r.specialties || []) || [])];
  const qualifs = [...new Set(p.qualifications?.map(q => q.display).filter(Boolean) || [])];

  body.innerHTML = `
    <div class="space-y-4">
      <div>
        <p class="text-xl font-bold text-gray-900">${esc(p.prefix)} ${esc(p.firstName)} ${esc(p.lastName)}</p>
        ${p.rpps ? `<p class="text-sm text-gray-500 mt-1">RPPS : ${esc(p.rpps)}</p>` : ''}
        ${p.identifiers?.filter(i => i.type === 'ADELI').map(i => `<p class="text-sm text-gray-500">ADELI : ${esc(i.value)}</p>`).join('') || ''}
      </div>
      ${qualifs.length || specs.length ? `
      <div>
        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Qualifications & Sp√©cialit√©s</h4>
        <div class="flex flex-wrap gap-2">
          ${[...specs, ...qualifs].map(s => `<span class="px-2.5 py-1 bg-primary-50 text-primary-700 rounded-full text-xs font-medium">${esc(s)}</span>`).join('')}
        </div>
      </div>` : ''}
      ${p.roles?.length ? p.roles.map((role, ri) => `
      <div class="bg-gray-50 rounded-lg p-3">
        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Lieu d'exercice${p.roles.length > 1 ? ` ${ri + 1}` : ''}</h4>
        ${role.address ? `<p class="text-sm text-gray-700 mb-1">üìç ${esc(role.address)}</p>` : ''}
        ${role.organization?.name ? `<p class="text-sm text-gray-700 mb-1">üè• ${esc(role.organization.name)}</p>` : ''}
        ${role.specialties?.length ? `<p class="text-sm text-gray-600">${role.specialties.map(esc).join(', ')}</p>` : ''}
      </div>`).join('') : ''}
      ${uniqueTelecoms.length ? `
      <div>
        <h4 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Contact</h4>
        <div class="space-y-1">
          ${uniqueTelecoms.map(t => `
            <p class="text-sm text-gray-700">
              ${t.system === 'phone' ? 'üìû' : t.system === 'email' ? '‚úâÔ∏è' : t.system === 'fax' ? 'üì†' : 'üìã'}
              ${esc(t.value)}
              ${t.use ? `<span class="text-gray-400 text-xs">(${esc(t.use)})</span>` : ''}
            </p>`).join('')}
        </div>
      </div>` : ''}
    </div>`;

  document.getElementById('modal-overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal(e) {
  if (e && e.target !== e.currentTarget) return;
  document.getElementById('modal-overlay').classList.add('hidden');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ‚îÄ‚îÄ‚îÄ Copy ‚îÄ‚îÄ‚îÄ
function formatCardText(p) {
  const lines = [];
  lines.push(`${p.prefix || ''} ${p.firstName} ${p.lastName}`.trim());
  if (p.rpps) lines.push(`RPPS : ${p.rpps}`);
  const adeli = p.identifiers?.find(i => i.type === 'ADELI');
  if (adeli) lines.push(`ADELI : ${adeli.value}`);

  const specs = [...new Set(p.roles?.flatMap(r => r.specialties || []) || [])];
  const qualifs = [...new Set(p.qualifications?.map(q => q.display).filter(Boolean) || [])];
  const allQualifs = [...new Set([...specs, ...qualifs])];
  if (allQualifs.length) lines.push(`Sp√©cialit√©s : ${allQualifs.join(', ')}`);

  for (const role of (p.roles || [])) {
    if (role.address) lines.push(`Adresse : ${role.address}`);
    if (role.organization?.name) lines.push(`Structure : ${role.organization.name}`);
  }

  const telecoms = p.roles?.flatMap(r => r.telecoms || []).filter(t => t.value) || [];
  const seen = new Set();
  for (const t of telecoms) {
    const key = `${t.system}:${t.value}`;
    if (seen.has(key)) continue;
    seen.add(key);
    const label = t.system === 'phone' ? 'T√©l' : t.system === 'email' ? 'Email' : t.system === 'fax' ? 'Fax' : 'Contact';
    lines.push(`${label} : ${t.value}`);
  }

  return lines.join('\n');
}

async function copyCard(index) {
  const p = currentResults[index];
  if (!p) return;
  await navigator.clipboard.writeText(formatCardText(p));
  showToast('Fiche copi√©e !');
}

async function copyCurrentCard() {
  if (!currentDetail) return;
  await navigator.clipboard.writeText(formatCardText(currentDetail));
  showToast('Fiche copi√©e !');
}

// ‚îÄ‚îÄ‚îÄ Selection & Basket ‚îÄ‚îÄ‚îÄ
function isInBasket(p) {
  // Match by RPPS or by id
  return basket.some(b => (b.rpps && b.rpps === p.rpps) || b.id === p.id);
}

function toggleSelect(index) {
  const p = currentResults[index];
  if (!p) return;

  if (isInBasket(p)) {
    // Remove from basket
    basket = basket.filter(b => !((b.rpps && b.rpps === p.rpps) || b.id === p.id));
  } else {
    // Add to basket
    basket.push(p);
  }

  // Update card visual
  const cards = document.getElementById('results').children;
  if (cards[index]) {
    const card = cards[index];
    const inBasket = isInBasket(p);
    card.className = card.className
      .replace(/border-primary-400 ring-2 ring-primary-100/g, '')
      .replace(/border-gray-200/g, '');
    card.classList.add(inBasket ? 'border-primary-400' : 'border-gray-200');
    if (inBasket) card.classList.add('ring-2', 'ring-primary-100');
    else card.classList.remove('ring-2', 'ring-primary-100');
    // Update checkbox
    const cb = card.querySelector('input[type=checkbox]');
    if (cb) cb.checked = inBasket;
  }
  updateBasketUI();
}

function toggleSelectAll() {
  const allInBasket = currentResults.every(p => isInBasket(p));
  if (allInBasket) {
    // Remove all current results from basket
    const currentIds = new Set(currentResults.map(p => p.rpps || p.id));
    basket = basket.filter(b => !currentIds.has(b.rpps || b.id));
  } else {
    // Add all current results to basket (skip duplicates)
    for (const p of currentResults) {
      if (!isInBasket(p)) basket.push(p);
    }
  }
  renderResults(currentResults);
  updateBasketUI();
}

function updateBasketUI() {
  const btnBasket = document.getElementById('btn-basket');
  const btnAll = document.getElementById('btn-select-all');
  const countEl = document.getElementById('basket-count');

  // Always show basket button if there are items
  if (basket.length > 0) {
    btnBasket.classList.remove('hidden');
    btnBasket.classList.add('flex');
  } else {
    btnBasket.classList.add('hidden');
    btnBasket.classList.remove('flex');
  }
  countEl.textContent = basket.length;

  // Update "tout s√©lectionner" button text
  if (currentResults.length > 0) {
    const allInBasket = currentResults.every(p => isInBasket(p));
    btnAll.textContent = allInBasket ? 'Tout d√©s√©lectionner' : 'Tout s√©lectionner';
  }

  // Update export button
  const btnExport = document.getElementById('btn-export');
  if (btnExport.classList.contains('flex')) {
    if (basket.length > 0) {
      btnExport.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg> Export s√©lection (${basket.length})`;
    } else {
      btnExport.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg> Export CSV (tout)`;
    }
  }

  // Update basket panel if open
  renderBasketPanel();
}

function toggleBasketPanel() {
  const panel = document.getElementById('basket-panel');
  panel.classList.toggle('hidden');
  if (!panel.classList.contains('hidden')) {
    renderBasketPanel();
    document.body.style.overflow = 'hidden';
  } else {
    document.body.style.overflow = '';
  }
}

function renderBasketPanel() {
  const list = document.getElementById('basket-list');
  if (!list) return;

  if (basket.length === 0) {
    list.innerHTML = '<div class="text-center py-8 text-gray-400 text-sm">Aucun professionnel s√©lectionn√©.<br>Cochez des r√©sultats pour les ajouter ici.</div>';
    return;
  }

  list.innerHTML = basket.map((p, i) => {
    const mainRole = p.roles?.[0] || {};
    const displayOrg = mainRole.organization?.name || '';
    const displayAddress = mainRole.address || mainRole.organization?.address || '';
    return `
      <div class="bg-gray-50 rounded-lg p-3 flex items-start gap-3">
        <div class="flex-1 min-w-0">
          <p class="font-medium text-gray-900 text-sm truncate">${esc(p.prefix)} ${esc(p.firstName)} ${esc(p.lastName)}</p>
          ${p.rpps ? `<p class="text-xs text-gray-500">RPPS ${esc(p.rpps)}</p>` : ''}
          ${displayOrg ? `<p class="text-xs text-gray-500 truncate">üè• ${esc(displayOrg)}</p>` : ''}
          ${displayAddress ? `<p class="text-xs text-gray-400 truncate">üìç ${esc(displayAddress)}</p>` : ''}
        </div>
        <button onclick="removeFromBasket(${i})" class="shrink-0 p-1 text-gray-400 hover:text-red-500 transition-colors" title="Retirer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>`;
  }).join('');
}

function removeFromBasket(index) {
  basket.splice(index, 1);
  renderResults(currentResults); // Refresh checkboxes
  updateBasketUI();
}

function clearBasket() {
  basket = [];
  renderResults(currentResults);
  updateBasketUI();
}

function exportBasketCSV() {
  if (!basket.length) return;
  exportCSVFromList(basket);
  showToast(`${basket.length} fiche(s) export√©e(s) !`);
}

async function copyAllBasket() {
  if (!basket.length) return;
  const text = basket.map(p => formatCardText(p)).join('\n\n---\n\n');
  await navigator.clipboard.writeText(text);
  showToast(`${basket.length} fiche(s) copi√©e(s) !`);
}

// ‚îÄ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  // If basket has items, export basket; otherwise export all current results
  const toExport = basket.length > 0 ? basket : currentResults;
  if (!toExport.length) return;
  exportCSVFromList(toExport);
  showToast(`${toExport.length} fiche(s) export√©e(s) !`);
}

function exportCSVFromList(list) {
  const headers = ['Nom', 'Pr√©nom', 'RPPS', 'ADELI', 'Sp√©cialit√©s', 'Adresse', 'Code Postal', 'Ville', 'T√©l√©phone', 'Email', 'Structure'];
  const rows = list.map(p => {
    const adeli = p.identifiers?.find(i => i.type === 'ADELI')?.value || '';
    const specs = [...new Set(p.roles?.flatMap(r => r.specialties || []) || [])].join('; ');
    const mainRole = p.roles?.[0] || {};
    const phones = p.roles?.flatMap(r => r.telecoms?.filter(t => t.system === 'phone').map(t => t.value) || []) || [];
    const emails = p.roles?.flatMap(r => r.telecoms?.filter(t => t.system === 'email').map(t => t.value) || []) || [];
    const orgName = mainRole.organization?.name || '';

    return [
      p.lastName, p.firstName, p.rpps || '', adeli, specs,
      mainRole.address || '', mainRole.postalCode || '', mainRole.city || '',
      [...new Set(phones)].join('; '), [...new Set(emails)].join('; '), orgName
    ];
  });

  const csvContent = [headers, ...rows]
    .map(row => row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(','))
    .join('\n');

  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `annuaire-sante-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ
function setLoading(on) {
  document.getElementById('loading').classList.toggle('hidden', !on);
  document.getElementById('btn-search').disabled = on;
}

function showError(msg) {
  document.getElementById('error-state').classList.remove('hidden');
  document.getElementById('error-msg').textContent = msg;
  document.getElementById('empty-state').classList.add('hidden');
}

function hideError() {
  document.getElementById('error-state').classList.add('hidden');
}

function clearForm() {
  ['input-name', 'input-rpps', 'input-city', 'input-specialty'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('results').innerHTML = '';
  document.getElementById('result-count').textContent = '';
  document.getElementById('empty-state').classList.remove('hidden');
  document.getElementById('btn-export').classList.add('hidden');
  document.getElementById('btn-select-all').classList.add('hidden');
  hideError();
  currentResults = [];
  // Note: on ne vide PAS le panier quand on efface la recherche
}

function showToast(msg, type = 'success') {
  const container = document.getElementById('toasts');
  const colors = type === 'success' ? 'bg-green-600' : type === 'warn' ? 'bg-yellow-500' : 'bg-red-500';
  const div = document.createElement('div');
  div.className = `toast px-4 py-2.5 ${colors} text-white text-sm font-medium rounded-lg shadow-lg`;
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => div.remove(), 2200);
}

function esc(str) {
  if (!str) return '';
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// ‚îÄ‚îÄ‚îÄ Specialty Autocomplete ‚îÄ‚îÄ‚îÄ
function onSpecialtyInput(value) {
  const list = document.getElementById('specialty-suggestions');
  if (!value || value.length < 1) {
    if (document.activeElement === document.getElementById('input-specialty') && !value) {
      showSpecialtySuggestions(SPECIALTIES.slice(0, 15));
    } else {
      list.classList.add('hidden');
    }
    return;
  }
  const lower = value.toLowerCase();
  const matches = SPECIALTIES.filter(s => s.label.toLowerCase().includes(lower)).slice(0, 10);
  if (matches.length === 0 || (matches.length === 1 && matches[0].label.toLowerCase() === lower)) {
    list.classList.add('hidden');
    return;
  }
  showSpecialtySuggestions(matches);
}

function showSpecialtySuggestions(matches) {
  const list = document.getElementById('specialty-suggestions');
  list.innerHTML = matches.map(s =>
    `<li class="px-4 py-2 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 cursor-pointer transition-colors"
         onmousedown="selectSpecialty('${s.label.replace(/'/g, "\\'")}')">${esc(s.label)}</li>`
  ).join('');
  list.classList.remove('hidden');
}

function selectSpecialty(value) {
  document.getElementById('input-specialty').value = value;
  hideSpecialtySuggestions();
}

function hideSpecialtySuggestions() {
  document.getElementById('specialty-suggestions').classList.add('hidden');
}

// ‚îÄ‚îÄ‚îÄ City Autocomplete (geo.api.gouv.fr) ‚îÄ‚îÄ‚îÄ
let cityDebounce = null;

function onCityInput(value) {
  clearTimeout(cityDebounce);
  const list = document.getElementById('city-suggestions');
  if (!value || value.length < 2) {
    list.classList.add('hidden');
    return;
  }
  cityDebounce = setTimeout(() => fetchCitySuggestions(value), 250);
}

async function fetchCitySuggestions(query) {
  const list = document.getElementById('city-suggestions');
  try {
    const res = await fetch(`https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&limit=8&fields=nom,codesPostaux,population&boost=population`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data.length) { list.classList.add('hidden'); return; }

    list.innerHTML = data.map(c => {
      const cp = c.codesPostaux?.[0] || '';
      const pop = c.population ? `${(c.population / 1000).toFixed(0)}k hab.` : '';
      return `<li class="px-4 py-2 text-sm text-gray-700 hover:bg-primary-50 hover:text-primary-700 cursor-pointer transition-colors flex justify-between items-center"
                  onmousedown="selectCity('${c.nom.replace(/'/g, "\\'")}')">
                <span>${esc(c.nom)} <span class="text-gray-400">${esc(cp)}</span></span>
                <span class="text-xs text-gray-400">${esc(pop)}</span>
              </li>`;
    }).join('');
    list.classList.remove('hidden');
  } catch (e) {
    list.classList.add('hidden');
  }
}

function selectCity(value) {
  document.getElementById('input-city').value = value;
  hideCitySuggestions();
}

function hideCitySuggestions() {
  document.getElementById('city-suggestions').classList.add('hidden');
}
</script>
</body>
</html>
